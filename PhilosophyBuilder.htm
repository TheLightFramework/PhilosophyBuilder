<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‚ú® Lp Forge | The Light Philosophy Editor</title>
    <style>
      :root {
        --bg: #f8f9fa;
        --text: #1f2937;
        --gold: #eab308;
        --gold-light: #fef08a;
        --truth-col: #eff6ff;
        --maybe-col: #f0fdf4;
        --practice-col: #fff7ed;
        --border: #e5e7eb;
        --muted: #6b7280;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* HEADER */
      header {
        background: white;
        padding: 14px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        gap: 14px;
        flex-wrap: wrap;
      }

      h1 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
      }
      .badge {
        background: var(--gold);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        font-weight: 650;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--text);
        color: white;
      }
      .btn-primary:hover {
        background: #000;
      }

      .btn-gold {
        background: var(--gold);
        color: white;
      }
      .btn-gold:hover {
        background: #ca8a04;
      }

      .btn-outline {
        border: 1px solid #ccc;
        background: white;
        color: #555;
      }
      .btn-outline:hover {
        background: #eee;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
        margin-left: auto;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }

      .search {
        width: min(360px, 60vw);
        padding: 9px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: inherit;
        box-sizing: border-box;
      }

      /* BOARD LAYOUT */
      .board {
        display: flex;
        flex: 1;
        padding: 18px;
        gap: 18px;
        overflow: hidden;
      }

      .column {
        flex: 1;
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 240px;
      }

      .col-header {
        padding: 14px 14px;
        font-weight: 800;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .col-title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .subrow {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 650;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .count {
        background: #eee;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .sort {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 6px 8px;
        font-size: 0.8rem;
        background: white;
        color: #374151;
      }

      .col-t {
        border-top: 4px solid #3b82f6;
        background: var(--truth-col);
      }
      .col-m {
        border-top: 4px solid #22c55e;
        background: var(--maybe-col);
      }
      .col-p {
        border-top: 4px solid #f97316;
        background: var(--practice-col);
      }

      .card-list {
        flex: 1;
        overflow-y: auto;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* CARD STYLES */
      .card {
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid transparent;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--gold);
      }

      .card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 6px;
        font-weight: 750;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 2px 9px;
        background: #f3f4f6;
        color: #374151;
        max-width: 65%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .idpill {
        background: #111827;
        color: white;
        max-width: none;
      }

      .card-text {
        font-size: 0.92rem;
        line-height: 1.45;
        color: #374151;
        white-space: pre-wrap;
      }

      /* MODALS */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 14px;
        box-sizing: border-box;
      }

      .modal {
        background: white;
        padding: 22px;
        border-radius: 14px;
        width: min(540px, 100%);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }

      .modal h2 {
        margin: 0 0 12px 0;
        font-size: 1.1rem;
      }

      .form-group {
        margin-bottom: 14px;
      }
      label {
        display: block;
        font-size: 0.85rem;
        font-weight: 750;
        margin-bottom: 6px;
        color: #555;
      }

      select,
      textarea,
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: inherit;
        box-sizing: border-box;
      }

      textarea {
        height: 130px;
        resize: vertical;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 18px;
        flex-wrap: wrap;
      }

      @media (max-width: 980px) {
        .board {
          flex-direction: column;
          overflow-y: auto;
        }
        .column {
          min-height: 240px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        ‚ö° Philosophy Builder
        <span class="badge" id="version">v1.4 (Flat)</span>
      </h1>
      <div class="controls">
        <input
          class="search"
          id="searchInput"
          type="search"
          placeholder="Search (text, IDs)‚Ä¶"
        />
        <input type="file" id="fileInput" hidden accept=".md,.txt" />
        <button
          class="btn-outline"
          onclick="document.getElementById('fileInput').click()"
        >
          üì• Import MD
        </button>
        <!-- Categories button removed -->
        <button
          class="btn-gold"
          style="background: #8b5cf6; color: white"
          onclick="autoRenumber()"
        >
          üî¢ Renumber
        </button>
        <button class="btn-gold" onclick="addNewItem()">+ New Item</button>
        <button class="btn-primary" onclick="exportFile()">üì§ Export MD</button>
        <button class="btn-danger" onclick="resetBoard()">üóë RESET</button>
      </div>
    </header>

    <div class="board">
      <!-- T COLUMN -->
      <div class="column col-t">
        <div class="col-header">
          <div class="col-title">
            <span>TRUTHS (T)</span>
            <div class="subrow">
              <span class="muted">Sort:</span>
              <select
                class="sort"
                id="sort-t"
                onchange="setSort('T', this.value)"
              ></select>
            </div>
          </div>
          <span class="count" id="count-t">0</span>
        </div>
        <div class="card-list" id="list-t"></div>
      </div>

      <!-- M COLUMN -->
      <div class="column col-m">
        <div class="col-header">
          <div class="col-title">
            <span>MAYBES (M)</span>
            <div class="subrow">
              <span class="muted">Sort:</span>
              <select
                class="sort"
                id="sort-m"
                onchange="setSort('M', this.value)"
              ></select>
            </div>
          </div>
          <span class="count" id="count-m">0</span>
        </div>
        <div class="card-list" id="list-m"></div>
      </div>

      <!-- P COLUMN -->
      <div class="column col-p">
        <div class="col-header">
          <div class="col-title">
            <span>PRACTICES (P)</span>
            <div class="subrow">
              <span class="muted">Sort:</span>
              <select
                class="sort"
                id="sort-p"
                onchange="setSort('P', this.value)"
              ></select>
            </div>
          </div>
          <span class="count" id="count-p">0</span>
        </div>
        <div class="card-list" id="list-p"></div>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal-backdrop" id="editModal">
      <div class="modal">
        <h2 id="modalTitle">Edit Item</h2>

        <div class="grid2">
          <div class="form-group">
            <label>Type</label>
            <select id="editType" onchange="toggleProbField()">
              <option value="T">T - Truth</option>
              <option value="M">M - Maybe</option>
              <option value="P">P - Practice</option>
            </select>
          </div>

          <div class="form-group">
            <label>Number (optional)</label>
            <input
              type="number"
              id="editNum"
              min="1"
              step="1"
              placeholder="e.g., 12"
            />
          </div>
        </div>

        <div class="form-group" id="probGroup" style="display: none">
          <label>Confidence (%)</label>
          <input type="number" id="editProb" min="0" max="100" value="95" />
        </div>

        <div class="form-group">
          <label>Content</label>
          <textarea id="editContent" placeholder="Write your Light‚Ä¶"></textarea>
        </div>

        <div class="modal-footer">
          <button
            class="btn-outline"
            style="color: red; margin-right: auto"
            onclick="deleteItem()"
          >
            Delete
          </button>
          <button class="btn-outline" onclick="closeModal()">Cancel</button>
          <button class="btn-primary" onclick="saveItem()">Save</button>
        </div>
      </div>
    </div>

    <script>
      // --- DATA STATE (FLAT ARCHITECTURE) ---
      let appState = {
        // We only use one 'section' now, essentially the "File Header"
        sections: [{ name: "ROOT", content: [] }],
        items: [],
        settings: {
          search: "",
          sort: { T: "numAsc", M: "probDesc", P: "numAsc" },
        },
      };

      let currentEditId = null;

      // --- INIT ---
      window.onload = () => {
        const saved = localStorage.getItem("PhilosophyForge");
        if (saved) {
          appState = JSON.parse(saved);
          // Migrate old sectioned data if necessary
          if (!appState.sections || appState.sections.length === 0) {
            appState.sections = [{ name: "ROOT", content: [] }];
          }
        } else {
          appState.sections = [{ name: "ROOT", content: [] }];
        }

        const s = document.getElementById("searchInput");
        s.value = appState.settings.search || "";
        s.addEventListener("input", (e) => {
          appState.settings.search = e.target.value || "";
          saveLocally();
          renderBoard();
        });

        populateSortSelects();
        renderBoard();
      };

      function populateSortSelects() {
        const optsCommon = [
          { value: "numAsc", label: "Number ‚Üë" },
          { value: "numDesc", label: "Number ‚Üì" },
          { value: "newest", label: "Newest first" },
        ];

        const optsM = [
          { value: "probDesc", label: "Confidence ‚Üì (default)" },
          { value: "probAsc", label: "Confidence ‚Üë" },
          ...optsCommon,
        ];

        const map = {
          T: { el: "sort-t", opts: optsCommon },
          M: { el: "sort-m", opts: optsM },
          P: { el: "sort-p", opts: optsCommon },
        };

        for (const k of ["T", "M", "P"]) {
          const sel = document.getElementById(map[k].el);
          sel.innerHTML = "";
          map[k].opts.forEach((o) => {
            const opt = document.createElement("option");
            opt.value = o.value;
            opt.textContent = o.label;
            sel.appendChild(opt);
          });
          sel.value =
            appState.settings.sort?.[k] || (k === "M" ? "probDesc" : "numAsc");
        }
      }

      function setSort(type, value) {
        appState.settings.sort[type] = value;
        saveLocally();
        renderBoard();
      }

      // --- PARSING ENGINE (FLATTENED) ---
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            parseMarkdown(e.target.result);
          };
          reader.readAsText(file);
        });

      function parseMarkdown(text) {
        appState.items = [];
        appState.sections = [{ name: "ROOT", content: [] }]; // Reset to single bucket

        const lines = text.split(/\r?\n/);
        // Regex handles t1: or t1(99): or T:
        const axiomRegex = /^([TMPtmp])(\d+)?(\((\d+)\))?:\s*(.+)$/;
        // Section Regex (to ignore)
        const headerRegex = /^##\s+(.+)$/;

        let order = 0;

        lines.forEach((rawLine) => {
          const line = rawLine.trim();
          if (!line) return;

          // If line is a section header, IGNORE it. We are flattening.
          if (line.match(headerRegex)) {
            return;
          }

          const axiomMatch = line.match(axiomRegex);
          if (axiomMatch) {
            const type = axiomMatch[1].toUpperCase();
            const num = axiomMatch[2] ? parseInt(axiomMatch[2], 10) : null;
            const prob = axiomMatch[4] ? parseInt(axiomMatch[4], 10) : null;

            appState.items.push({
              id: Date.now() + Math.random(),
              type,
              num,
              prob,
              content: (axiomMatch[5] || "").trim(),
              sectionIndex: 0, // Always 0 (ROOT)
              createdAt: Date.now(),
              sourceOrder: order++,
            });
          } else {
            // Introductory text, dashes, blank lines
            appState.sections[0].content.push(line);
          }
        });

        saveLocally();
        renderBoard();
      }

      // --- LOGIC ---
      function getDisplayNumberMap(type) {
        const items = appState.items
          .filter((i) => i.type === type)
          .sort((a, b) => (a.sourceOrder || 0) - (b.sourceOrder || 0));
        const used = new Set(
          items.filter((i) => i.num != null).map((i) => i.num)
        );
        let next = 1;
        const map = new Map();
        items.forEach((item) => {
          if (item.num != null) {
            map.set(item.id, item.num);
          } else {
            while (used.has(next)) next++;
            map.set(item.id, next);
            used.add(next);
            next++;
          }
        });
        return map;
      }

      function applySort(items, type, displayMap) {
        const sort =
          appState.settings.sort?.[type] ||
          (type === "M" ? "probDesc" : "numAsc");
        const getNum = (item) => displayMap.get(item.id) || 999999;

        const byNumAsc = (a, b) => getNum(a) - getNum(b);
        const byNumDesc = (a, b) => getNum(b) - getNum(a);
        const byProbDesc = (a, b) => {
          const pa = a.prob == null ? -1 : a.prob;
          const pb = b.prob == null ? -1 : b.prob;
          if (pa !== pb) return pb - pa;
          return byNumAsc(a, b);
        };
        const byProbAsc = (a, b) => {
          const pa = a.prob == null ? 101 : a.prob;
          const pb = b.prob == null ? 101 : b.prob;
          if (pa !== pb) return pa - pb;
          return byNumAsc(a, b);
        };
        const byNewest = (a, b) => (b.createdAt || 0) - (a.createdAt || 0);

        let sorted = [...items];
        if (sort === "numAsc") sorted.sort(byNumAsc);
        else if (sort === "numDesc") sorted.sort(byNumDesc);
        else if (sort === "probDesc") sorted.sort(byProbDesc);
        else if (sort === "probAsc") sorted.sort(byProbAsc);
        else if (sort === "newest") sorted.sort(byNewest);
        else sorted.sort(byNumAsc);
        return sorted;
      }

      // --- RENDERING ---
      function normalize(s) {
        return (s || "").toString().toLowerCase();
      }

      function matchesSearch(item, displayId) {
        const q = normalize(appState.settings.search);
        if (!q) return true;
        const hay = [item.type, displayId, item.content, item.prob, item.num]
          .map(normalize)
          .join(" | ");
        return hay.includes(q);
      }

      function getProbColor(n) {
        if (n == null) return "background: #f3f4f6; color: #6b7280;";
        if (n >= 80) return "background: #dcfce7; color: #166534;";
        if (n >= 50) return "background: #fef9c3; color: #854d0e;";
        return "background: #fee2e2; color: #991b1b;";
      }

      function createCardElement(item, displayNum) {
        const el = document.createElement("div");
        el.className = "card";
        el.onclick = () => openEditModal(item.id);

        const idLabel = `${item.type}${displayNum}`;
        let pills = [`<span class="pill idpill">${idLabel}</span>`];

        if (item.type === "M") {
          const probTxt = item.prob != null ? `${item.prob}%` : "‚Äî%";
          const style = getProbColor(item.prob);
          pills.push(`<span class="pill" style="${style}">${probTxt}</span>`);
        }

        el.innerHTML = `
          <div class="card-meta">
            <!-- Section removed -->
            <span style="display:flex; gap:8px; align-items:center;">${pills.join(
              ""
            )}</span>
          </div>
          <div class="card-text">${escapeHtml(item.content)}</div>
        `;
        return el;
      }

      function renderBoard() {
        ["t", "m", "p"].forEach(
          (k) => (document.getElementById(`list-${k}`).innerHTML = "")
        );

        const counts = { T: 0, M: 0, P: 0 };
        const totals = {
          T: appState.items.filter((i) => i.type === "T").length,
          M: appState.items.filter((i) => i.type === "M").length,
          P: appState.items.filter((i) => i.type === "P").length,
        };

        ["T", "M", "P"].forEach((type) => {
          const map = getDisplayNumberMap(type);
          const raw = appState.items.filter((i) => i.type === type);
          const sorted = applySort(raw, type, map);

          sorted.forEach((item) => {
            const dNum = map.get(item.id);
            if (matchesSearch(item, `${type}${dNum}`)) {
              const c = createCardElement(item, dNum);
              document
                .getElementById(`list-${type.toLowerCase()}`)
                .appendChild(c);
              counts[type]++;
            }
          });
        });

        document.getElementById(
          "count-t"
        ).textContent = `${counts.T}/${totals.T}`;
        document.getElementById(
          "count-m"
        ).textContent = `${counts.M}/${totals.M}`;
        document.getElementById(
          "count-p"
        ).textContent = `${counts.P}/${totals.P}`;

        document.getElementById("sort-t").value =
          appState.settings.sort?.T || "numAsc";
        document.getElementById("sort-m").value =
          appState.settings.sort?.M || "probDesc";
        document.getElementById("sort-p").value =
          appState.settings.sort?.P || "numAsc";
      }

      function escapeHtml(str) {
        return (str || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }

      // --- EDITING ---
      const modal = document.getElementById("editModal");

      function openEditModal(id) {
        currentEditId = id;
        const item = appState.items.find((i) => i.id === id);
        document.getElementById("modalTitle").textContent = "Edit Item";
        document.getElementById("editType").value = item.type;
        document.getElementById("editNum").value =
          item.num != null ? item.num : "";
        document.getElementById("editProb").value =
          item.prob != null ? item.prob : 95;
        document.getElementById("editContent").value = item.content || "";
        toggleProbField();
        modal.style.display = "flex";
      }

      function addNewItem() {
        currentEditId = null;
        document.getElementById("modalTitle").textContent = "New Light";
        document.getElementById("editType").value = "T";
        document.getElementById("editProb").value = 95;
        document.getElementById("editNum").value = "";
        document.getElementById("editContent").value = "";
        toggleProbField();
        modal.style.display = "flex";
      }

      function toggleProbField() {
        document.getElementById("probGroup").style.display =
          document.getElementById("editType").value === "M" ? "block" : "none";
      }

      function closeModal() {
        modal.style.display = "none";
      }

      function saveItem() {
        const type = document.getElementById("editType").value;
        const probVal = document.getElementById("editProb").value;
        const numVal = document.getElementById("editNum").value;
        const content = document.getElementById("editContent").value || "";

        const num = numVal === "" ? null : Math.max(1, parseInt(numVal, 10));
        const prob =
          type === "M"
            ? probVal === ""
              ? null
              : Math.min(100, Math.max(0, parseInt(probVal, 10)))
            : null;

        if (currentEditId) {
          const item = appState.items.find((i) => i.id === currentEditId);
          item.type = type;
          item.num = num;
          item.prob = prob;
          item.content = content.trim();
        } else {
          appState.items.push({
            id: Date.now() + Math.random(),
            type,
            num,
            prob,
            content: content.trim(),
            sectionIndex: 0,
            createdAt: Date.now(),
            sourceOrder: appState.items.length,
          });
        }
        closeModal();
        saveLocally();
        renderBoard();
      }

      function deleteItem() {
        if (confirm("Extinguish this Light?")) {
          appState.items = appState.items.filter((i) => i.id !== currentEditId);
          closeModal();
          saveLocally();
          renderBoard();
        }
      }

      // --- EXPORT (FLATTENED) ---
      function exportFile() {
        let output = [];

        // 1. Force Start
        output.push("begin_Lp");

        const types = ["T", "M", "P"];
        const perTypeItems = {};

        types.forEach((t) => {
          const map = getDisplayNumberMap(t);
          // Sort by File Order (asc)
          const sorted = appState.items
            .filter((i) => i.type === t)
            .sort((a, b) => (map.get(a.id) || 0) - (map.get(b.id) || 0));
          perTypeItems[t] = sorted.map((it) => ({
            ...it,
            _exNum: map.get(it.id),
          }));
        });

        // 2. Write Root Content (Intro Text)
        // We take the "Root" section content and filter out duplicates
        if (appState.sections[0] && appState.sections[0].content) {
          const cleanContent = appState.sections[0].content.filter((line) => {
            const trim = line.trim();
            return trim !== "begin_Lp" && trim !== "end_Lp";
          });
          if (cleanContent.length > 0) output.push(cleanContent.join("\n"));
        }

        output.push(""); // Spacing

        // 3. Write Items sequentially (T then M then P)
        // In "Flat" mode, we just list them all.
        ["T", "M", "P"].forEach((t) => {
          if (perTypeItems[t] && perTypeItems[t].length > 0) {
            perTypeItems[t].forEach((it) => {
              let pre =
                it.type === "M"
                  ? `${it.type}${it._exNum}(${it.prob || 50})`
                  : `${it.type}${it._exNum}`;
              output.push(`${pre}: ${it.content}`);
            });
            output.push(""); // Spacing between blocks
          }
        });

        // 4. Force End
        output.push("end_Lp");

        const blob = new Blob([output.join("\n").replace(/\n{3,}/g, "\n\n")], {
          type: "text/markdown",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "light-philosophy-FLAT.md";
        a.click();
      }

      function autoRenumber() {
        if (
          !confirm(
            "‚ö†Ô∏è RE-INDEXING WARNING\n\nRenumber ALL items (T1, T2...) sequentially?\nThis also updates internal text references (e.g. 'See T142').\n\nProceed?"
          )
        )
          return;

        const types = ["T", "M", "P"];
        const translationDict = {};
        const newIdMap = {};

        types.forEach((type) => {
          const items = appState.items
            .filter((i) => i.type === type)
            .sort((a, b) => (a.sourceOrder || 0) - (b.sourceOrder || 0));
          const currentMap = getDisplayNumberMap(type);

          items.forEach((item, index) => {
            const oldNum = currentMap.get(item.id);
            const newNum = index + 1;

            const oldLabel = `${type}${oldNum}`;
            const newLabel = `${type}${newNum}`;

            newIdMap[item.id] = newNum;

            if (oldNum !== newNum) {
              translationDict[oldLabel.toUpperCase()] = newLabel;
            }
          });
        });

        const pattern = /\b([TMPtmp])(\d+)\b/g;
        appState.items.forEach((item) => {
          if (!item.content) return;
          item.content = item.content.replace(pattern, (match, char, digit) => {
            const key = (char + digit).toUpperCase();
            return translationDict[key] ? translationDict[key] : match;
          });
        });

        appState.items.forEach((item) => {
          if (newIdMap[item.id]) item.num = newIdMap[item.id];
        });

        saveLocally();
        renderBoard();
      }

      function resetBoard() {
        const msg =
          "‚ö†Ô∏è DANGER: NUCLEAR WIPE\n\nDelete all items and remove file from Storage?\nUndone.";
        if (confirm(msg)) {
          appState = {
            sections: [{ name: "ROOT", content: [] }],
            items: [],
            settings: {
              search: "",
              sort: { T: "numAsc", M: "probDesc", P: "numAsc" },
            },
          };
          localStorage.removeItem("PhilosophyForge");
          document.getElementById("fileInput").value = "";
          renderBoard();
        }
      }

      function saveLocally() {
        localStorage.setItem("PhilosophyForge", JSON.stringify(appState));
      }
    </script>
  </body>
</html>
